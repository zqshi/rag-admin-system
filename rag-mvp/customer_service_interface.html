<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能客服系统 - Customer Service RAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-container {
            height: 400px;
            overflow-y: auto;
        }
        .message-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .message-bot {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 头部 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">🤖 智能客服系统</h1>
                    <p class="text-gray-600 mt-2">基于RAG架构的专业客服AI - 真正理解客户需求</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center space-x-2">
                        <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                        <span class="text-sm text-gray-600">系统在线</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">会话ID: <span id="sessionId">loading...</span></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- 聊天界面 -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-lg">
                    <!-- 聊天头部 -->
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-t-lg">
                        <h2 class="text-lg font-semibold">客服对话</h2>
                        <p class="text-sm opacity-90">我是您的专属AI客服，有什么可以帮助您的？</p>
                    </div>

                    <!-- 聊天区域 -->
                    <div id="chatContainer" class="chat-container p-4 space-y-4">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm">🤖</span>
                            </div>
                            <div class="flex-1 bg-gray-100 rounded-lg p-3">
                                <p class="text-gray-800">您好！欢迎使用智能客服系统。我可以帮您：</p>
                                <ul class="text-sm text-gray-600 mt-2 space-y-1">
                                    <li>• 📋 查询订单状态</li>
                                    <li>• 💰 账单和费用问题</li>
                                    <li>• 🔧 技术支持</li>
                                    <li>• 📞 投诉和建议</li>
                                    <li>• ℹ️ 产品信息咨询</li>
                                </ul>
                                <p class="text-sm text-gray-600 mt-2">请告诉我您遇到的问题。</p>
                            </div>
                        </div>
                    </div>

                    <!-- 输入区域 -->
                    <div class="border-t p-4">
                        <div class="flex space-x-3">
                            <input 
                                type="text" 
                                id="messageInput" 
                                placeholder="请输入您的问题..."
                                class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"
                                onkeypress="handleKeyPress(event)"
                            >
                            <button 
                                onclick="sendMessage()" 
                                class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition"
                                id="sendButton"
                            >
                                发送
                            </button>
                        </div>
                        
                        <!-- 快捷回复 -->
                        <div class="mt-3 flex flex-wrap gap-2">
                            <button onclick="quickReply('我的订单什么时候发货？')" class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300">订单查询</button>
                            <button onclick="quickReply('为什么扣费这么多？')" class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300">账单问题</button>
                            <button onclick="quickReply('系统打不开了')" class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300">技术故障</button>
                            <button onclick="quickReply('我要投诉！')" class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300">投诉建议</button>
                            <button onclick="quickReply('转人工客服')" class="text-xs bg-red-200 text-red-700 px-3 py-1 rounded-full hover:bg-red-300">人工客服</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 侧边栏 -->
            <div class="space-y-6">
                <!-- 对话状态 -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">对话状态</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">意图识别:</span>
                            <span id="currentIntent" class="font-medium text-blue-600">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">置信度:</span>
                            <span id="currentConfidence" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">优先级:</span>
                            <span id="currentPriority" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">响应时间:</span>
                            <span id="responseTime" class="font-medium">-</span>
                        </div>
                    </div>
                </div>

                <!-- 建议操作 -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">建议操作</h3>
                    <div id="suggestedActions" class="space-y-2">
                        <p class="text-sm text-gray-500">暂无建议</p>
                    </div>
                </div>

                <!-- 满意度评价 -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">服务评价</h3>
                    <div class="text-center">
                        <p class="text-sm text-gray-600 mb-3">请为本次服务打分</p>
                        <div class="flex justify-center space-x-1 mb-3">
                            <button onclick="rateSatisfaction(1)" class="text-2xl hover:scale-110 transition" title="很不满意">😞</button>
                            <button onclick="rateSatisfaction(2)" class="text-2xl hover:scale-110 transition" title="不满意">😐</button>
                            <button onclick="rateSatisfaction(3)" class="text-2xl hover:scale-110 transition" title="一般">🙂</button>
                            <button onclick="rateSatisfaction(4)" class="text-2xl hover:scale-110 transition" title="满意">😊</button>
                            <button onclick="rateSatisfaction(5)" class="text-2xl hover:scale-110 transition" title="非常满意">😍</button>
                        </div>
                        <textarea 
                            id="feedbackText" 
                            placeholder="请留下您的宝贵建议..."
                            class="w-full text-xs border border-gray-300 rounded p-2 h-16 resize-none"
                        ></textarea>
                    </div>
                </div>

                <!-- 系统信息 -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">系统信息</h3>
                    <div class="text-xs text-gray-600 space-y-1">
                        <div>版本: v3.0.0</div>
                        <div>引擎: Customer Service RAG</div>
                        <div>模式: 智能客服</div>
                        <div id="systemStatus">状态: <span class="text-green-600">正常</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let sessionId = generateSessionId();
        
        // 显示会话ID
        document.getElementById('sessionId').textContent = sessionId;
        
        function generateSessionId() {
            return 'cs_' + Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function quickReply(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // 显示用户消息
            addMessage(message, 'user');
            input.value = '';
            
            // 显示正在输入提示
            const typingId = addTypingIndicator();
            
            try {
                const response = await fetch(`${API_BASE}/api/customer/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: message,
                        channel: 'web'
                    })
                });
                
                const data = await response.json();
                
                // 移除正在输入提示
                removeTypingIndicator(typingId);
                
                if (response.ok) {
                    // 显示AI回复
                    addMessage(data.response, 'bot', {
                        intent: data.intent,
                        confidence: data.confidence,
                        priority: data.priority,
                        sources: data.sources,
                        escalation_needed: data.escalation_needed,
                        suggested_actions: data.suggested_actions,
                        response_time: data.response_time_ms
                    });
                    
                    // 更新侧边栏状态
                    updateSidebarStatus(data);
                    
                } else {
                    addMessage('抱歉，系统出现问题，请稍后重试。', 'bot');
                }
                
            } catch (error) {
                console.error('发送消息失败:', error);
                removeTypingIndicator(typingId);
                addMessage('网络连接失败，请检查网络后重试。', 'bot');
            }
        }
        
        function addMessage(content, type, metadata = null) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-3';
            
            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 message-user rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">👤</span>
                    </div>
                    <div class="flex-1 bg-blue-100 rounded-lg p-3">
                        <p class="text-gray-800">${content}</p>
                    </div>
                `;
            } else {
                let sourcesHTML = '';
                if (metadata && metadata.sources && metadata.sources.length > 0) {
                    sourcesHTML = `
                        <div class="text-xs text-gray-500 mt-2">
                            📚 参考来源: ${metadata.sources.slice(0, 2).join(', ')}
                        </div>
                    `;
                }
                
                let escalationHTML = '';
                if (metadata && metadata.escalation_needed) {
                    escalationHTML = `
                        <div class="mt-2 p-2 bg-yellow-100 border border-yellow-300 rounded text-sm">
                            ⚠️ 系统建议转接人工客服处理
                            <button onclick="requestHumanAgent()" class="ml-2 text-blue-600 underline">立即转接</button>
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">🤖</span>
                    </div>
                    <div class="flex-1 bg-gray-100 rounded-lg p-3">
                        <p class="text-gray-800">${content}</p>
                        ${sourcesHTML}
                        ${escalationHTML}
                    </div>
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function addTypingIndicator() {
            const container = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            const typingId = 'typing_' + Date.now();
            typingDiv.id = typingId;
            typingDiv.className = 'flex items-start space-x-3 typing-indicator';
            
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center">
                    <span class="text-white text-sm">🤖</span>
                </div>
                <div class="flex-1 bg-gray-100 rounded-lg p-3">
                    <p class="text-gray-600">正在思考中...</p>
                </div>
            `;
            
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
            
            return typingId;
        }
        
        function removeTypingIndicator(typingId) {
            const typingDiv = document.getElementById(typingId);
            if (typingDiv) {
                typingDiv.remove();
            }
        }
        
        function updateSidebarStatus(data) {
            document.getElementById('currentIntent').textContent = data.intent;
            document.getElementById('currentConfidence').textContent = (data.confidence * 100).toFixed(1) + '%';
            document.getElementById('currentPriority').textContent = data.priority;
            document.getElementById('responseTime').textContent = data.response_time + 'ms';
            
            // 更新建议操作
            const actionsContainer = document.getElementById('suggestedActions');
            if (data.suggested_actions && data.suggested_actions.length > 0) {
                actionsContainer.innerHTML = data.suggested_actions
                    .map(action => `<button class="w-full text-left text-sm bg-blue-50 hover:bg-blue-100 p-2 rounded border">${action}</button>`)
                    .join('');
            }
        }
        
        async function requestHumanAgent() {
            try {
                const response = await fetch(`${API_BASE}/api/customer/escalate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        reason: '用户主动请求',
                        customer_message: '用户请求转接人工客服'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addMessage(`${data.message} 工单号: ${data.ticket_id}`, 'bot');
                } else {
                    addMessage('转接失败，请稍后重试。', 'bot');
                }
                
            } catch (error) {
                console.error('转接失败:', error);
                addMessage('转接失败，请稍后重试。', 'bot');
            }
        }
        
        async function rateSatisfaction(score) {
            const feedback = document.getElementById('feedbackText').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/customer/satisfaction`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        score: score,
                        feedback: feedback
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addMessage(`感谢您给出${score}星评价！您的反馈对我们很重要。`, 'bot');
                    document.getElementById('feedbackText').value = '';
                } else {
                    console.error('评价提交失败');
                }
                
            } catch (error) {
                console.error('评价提交失败:', error);
            }
        }
        
        // 页面加载完成后检查系统状态
        window.onload = async function() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    document.getElementById('systemStatus').innerHTML = '状态: <span class="text-green-600">正常</span>';
                } else {
                    document.getElementById('systemStatus').innerHTML = '状态: <span class="text-yellow-600">降级</span>';
                }
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = '状态: <span class="text-red-600">离线</span>';
            }
        };
    </script>
</body>
</html>