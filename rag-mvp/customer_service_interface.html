<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å®¢æœç³»ç»Ÿ - Customer Service RAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-container {
            height: 400px;
            overflow-y: auto;
        }
        .message-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .message-bot {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- å¤´éƒ¨ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">ğŸ¤– æ™ºèƒ½å®¢æœç³»ç»Ÿ</h1>
                    <p class="text-gray-600 mt-2">åŸºäºRAGæ¶æ„çš„ä¸“ä¸šå®¢æœAI - çœŸæ­£ç†è§£å®¢æˆ·éœ€æ±‚</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center space-x-2">
                        <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                        <span class="text-sm text-gray-600">ç³»ç»Ÿåœ¨çº¿</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">ä¼šè¯ID: <span id="sessionId">loading...</span></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- èŠå¤©ç•Œé¢ -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-lg">
                    <!-- èŠå¤©å¤´éƒ¨ -->
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-t-lg">
                        <h2 class="text-lg font-semibold">å®¢æœå¯¹è¯</h2>
                        <p class="text-sm opacity-90">æˆ‘æ˜¯æ‚¨çš„ä¸“å±AIå®¢æœï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ</p>
                    </div>

                    <!-- èŠå¤©åŒºåŸŸ -->
                    <div id="chatContainer" class="chat-container p-4 space-y-4">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm">ğŸ¤–</span>
                            </div>
                            <div class="flex-1 bg-gray-100 rounded-lg p-3">
                                <p class="text-gray-800">æ‚¨å¥½ï¼æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å®¢æœç³»ç»Ÿã€‚æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
                                <ul class="text-sm text-gray-600 mt-2 space-y-1">
                                    <li>â€¢ ğŸ“‹ æŸ¥è¯¢è®¢å•çŠ¶æ€</li>
                                    <li>â€¢ ğŸ’° è´¦å•å’Œè´¹ç”¨é—®é¢˜</li>
                                    <li>â€¢ ğŸ”§ æŠ€æœ¯æ”¯æŒ</li>
                                    <li>â€¢ ğŸ“ æŠ•è¯‰å’Œå»ºè®®</li>
                                    <li>â€¢ â„¹ï¸ äº§å“ä¿¡æ¯å’¨è¯¢</li>
                                </ul>
                                <p class="text-sm text-gray-600 mt-2">è¯·å‘Šè¯‰æˆ‘æ‚¨é‡åˆ°çš„é—®é¢˜ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="border-t p-4">
                        <div class="flex space-x-3">
                            <input 
                                type="text" 
                                id="messageInput" 
                                placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
                                class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"
                                onkeypress="handleKeyPress(event)"
                            >
                            <button 
                                onclick="sendMessage()" 
                                class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition"
                                id="sendButton"
                            >
                                å‘é€
                            </button>
                        </div>
                        
                        <!-- å¿«æ·å›å¤ -->
                        <div class="mt-3 flex flex-wrap gap-2">
                            <button onclick="quickReply('æˆ‘çš„è®¢å•ä»€ä¹ˆæ—¶å€™å‘è´§ï¼Ÿ')" class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300">è®¢å•æŸ¥è¯¢</button>
                            <button onclick="quickReply('ä¸ºä»€ä¹ˆæ‰£è´¹è¿™ä¹ˆå¤šï¼Ÿ')" class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300">è´¦å•é—®é¢˜</button>
                            <button onclick="quickReply('ç³»ç»Ÿæ‰“ä¸å¼€äº†')" class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300">æŠ€æœ¯æ•…éšœ</button>
                            <button onclick="quickReply('æˆ‘è¦æŠ•è¯‰ï¼')" class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300">æŠ•è¯‰å»ºè®®</button>
                            <button onclick="quickReply('è½¬äººå·¥å®¢æœ')" class="text-xs bg-red-200 text-red-700 px-3 py-1 rounded-full hover:bg-red-300">äººå·¥å®¢æœ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¾§è¾¹æ  -->
            <div class="space-y-6">
                <!-- å¯¹è¯çŠ¶æ€ -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">å¯¹è¯çŠ¶æ€</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">æ„å›¾è¯†åˆ«:</span>
                            <span id="currentIntent" class="font-medium text-blue-600">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ç½®ä¿¡åº¦:</span>
                            <span id="currentConfidence" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ä¼˜å…ˆçº§:</span>
                            <span id="currentPriority" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">å“åº”æ—¶é—´:</span>
                            <span id="responseTime" class="font-medium">-</span>
                        </div>
                    </div>
                </div>

                <!-- å»ºè®®æ“ä½œ -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">å»ºè®®æ“ä½œ</h3>
                    <div id="suggestedActions" class="space-y-2">
                        <p class="text-sm text-gray-500">æš‚æ— å»ºè®®</p>
                    </div>
                </div>

                <!-- æ»¡æ„åº¦è¯„ä»· -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">æœåŠ¡è¯„ä»·</h3>
                    <div class="text-center">
                        <p class="text-sm text-gray-600 mb-3">è¯·ä¸ºæœ¬æ¬¡æœåŠ¡æ‰“åˆ†</p>
                        <div class="flex justify-center space-x-1 mb-3">
                            <button onclick="rateSatisfaction(1)" class="text-2xl hover:scale-110 transition" title="å¾ˆä¸æ»¡æ„">ğŸ˜</button>
                            <button onclick="rateSatisfaction(2)" class="text-2xl hover:scale-110 transition" title="ä¸æ»¡æ„">ğŸ˜</button>
                            <button onclick="rateSatisfaction(3)" class="text-2xl hover:scale-110 transition" title="ä¸€èˆ¬">ğŸ™‚</button>
                            <button onclick="rateSatisfaction(4)" class="text-2xl hover:scale-110 transition" title="æ»¡æ„">ğŸ˜Š</button>
                            <button onclick="rateSatisfaction(5)" class="text-2xl hover:scale-110 transition" title="éå¸¸æ»¡æ„">ğŸ˜</button>
                        </div>
                        <textarea 
                            id="feedbackText" 
                            placeholder="è¯·ç•™ä¸‹æ‚¨çš„å®è´µå»ºè®®..."
                            class="w-full text-xs border border-gray-300 rounded p-2 h-16 resize-none"
                        ></textarea>
                    </div>
                </div>

                <!-- ç³»ç»Ÿä¿¡æ¯ -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">ç³»ç»Ÿä¿¡æ¯</h3>
                    <div class="text-xs text-gray-600 space-y-1">
                        <div>ç‰ˆæœ¬: v3.0.0</div>
                        <div>å¼•æ“: Customer Service RAG</div>
                        <div>æ¨¡å¼: æ™ºèƒ½å®¢æœ</div>
                        <div id="systemStatus">çŠ¶æ€: <span class="text-green-600">æ­£å¸¸</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let sessionId = generateSessionId();
        
        // æ˜¾ç¤ºä¼šè¯ID
        document.getElementById('sessionId').textContent = sessionId;
        
        function generateSessionId() {
            return 'cs_' + Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function quickReply(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            input.value = '';
            
            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æç¤º
            const typingId = addTypingIndicator();
            
            try {
                const response = await fetch(`${API_BASE}/api/customer/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: message,
                        channel: 'web'
                    })
                });
                
                const data = await response.json();
                
                // ç§»é™¤æ­£åœ¨è¾“å…¥æç¤º
                removeTypingIndicator(typingId);
                
                if (response.ok) {
                    // æ˜¾ç¤ºAIå›å¤
                    addMessage(data.response, 'bot', {
                        intent: data.intent,
                        confidence: data.confidence,
                        priority: data.priority,
                        sources: data.sources,
                        escalation_needed: data.escalation_needed,
                        suggested_actions: data.suggested_actions,
                        response_time: data.response_time_ms
                    });
                    
                    // æ›´æ–°ä¾§è¾¹æ çŠ¶æ€
                    updateSidebarStatus(data);
                    
                } else {
                    addMessage('æŠ±æ­‰ï¼Œç³»ç»Ÿå‡ºç°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'bot');
                }
                
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                removeTypingIndicator(typingId);
                addMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚', 'bot');
            }
        }
        
        function addMessage(content, type, metadata = null) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-3';
            
            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 message-user rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">ğŸ‘¤</span>
                    </div>
                    <div class="flex-1 bg-blue-100 rounded-lg p-3">
                        <p class="text-gray-800">${content}</p>
                    </div>
                `;
            } else {
                let sourcesHTML = '';
                if (metadata && metadata.sources && metadata.sources.length > 0) {
                    sourcesHTML = `
                        <div class="text-xs text-gray-500 mt-2">
                            ğŸ“š å‚è€ƒæ¥æº: ${metadata.sources.slice(0, 2).join(', ')}
                        </div>
                    `;
                }
                
                let escalationHTML = '';
                if (metadata && metadata.escalation_needed) {
                    escalationHTML = `
                        <div class="mt-2 p-2 bg-yellow-100 border border-yellow-300 rounded text-sm">
                            âš ï¸ ç³»ç»Ÿå»ºè®®è½¬æ¥äººå·¥å®¢æœå¤„ç†
                            <button onclick="requestHumanAgent()" class="ml-2 text-blue-600 underline">ç«‹å³è½¬æ¥</button>
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">ğŸ¤–</span>
                    </div>
                    <div class="flex-1 bg-gray-100 rounded-lg p-3">
                        <p class="text-gray-800">${content}</p>
                        ${sourcesHTML}
                        ${escalationHTML}
                    </div>
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function addTypingIndicator() {
            const container = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            const typingId = 'typing_' + Date.now();
            typingDiv.id = typingId;
            typingDiv.className = 'flex items-start space-x-3 typing-indicator';
            
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center">
                    <span class="text-white text-sm">ğŸ¤–</span>
                </div>
                <div class="flex-1 bg-gray-100 rounded-lg p-3">
                    <p class="text-gray-600">æ­£åœ¨æ€è€ƒä¸­...</p>
                </div>
            `;
            
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
            
            return typingId;
        }
        
        function removeTypingIndicator(typingId) {
            const typingDiv = document.getElementById(typingId);
            if (typingDiv) {
                typingDiv.remove();
            }
        }
        
        function updateSidebarStatus(data) {
            document.getElementById('currentIntent').textContent = data.intent;
            document.getElementById('currentConfidence').textContent = (data.confidence * 100).toFixed(1) + '%';
            document.getElementById('currentPriority').textContent = data.priority;
            document.getElementById('responseTime').textContent = data.response_time + 'ms';
            
            // æ›´æ–°å»ºè®®æ“ä½œ
            const actionsContainer = document.getElementById('suggestedActions');
            if (data.suggested_actions && data.suggested_actions.length > 0) {
                actionsContainer.innerHTML = data.suggested_actions
                    .map(action => `<button class="w-full text-left text-sm bg-blue-50 hover:bg-blue-100 p-2 rounded border">${action}</button>`)
                    .join('');
            }
        }
        
        async function requestHumanAgent() {
            try {
                const response = await fetch(`${API_BASE}/api/customer/escalate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        reason: 'ç”¨æˆ·ä¸»åŠ¨è¯·æ±‚',
                        customer_message: 'ç”¨æˆ·è¯·æ±‚è½¬æ¥äººå·¥å®¢æœ'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addMessage(`${data.message} å·¥å•å·: ${data.ticket_id}`, 'bot');
                } else {
                    addMessage('è½¬æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'bot');
                }
                
            } catch (error) {
                console.error('è½¬æ¥å¤±è´¥:', error);
                addMessage('è½¬æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'bot');
            }
        }
        
        async function rateSatisfaction(score) {
            const feedback = document.getElementById('feedbackText').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/customer/satisfaction`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        score: score,
                        feedback: feedback
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addMessage(`æ„Ÿè°¢æ‚¨ç»™å‡º${score}æ˜Ÿè¯„ä»·ï¼æ‚¨çš„åé¦ˆå¯¹æˆ‘ä»¬å¾ˆé‡è¦ã€‚`, 'bot');
                    document.getElementById('feedbackText').value = '';
                } else {
                    console.error('è¯„ä»·æäº¤å¤±è´¥');
                }
                
            } catch (error) {
                console.error('è¯„ä»·æäº¤å¤±è´¥:', error);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        window.onload = async function() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    document.getElementById('systemStatus').innerHTML = 'çŠ¶æ€: <span class="text-green-600">æ­£å¸¸</span>';
                } else {
                    document.getElementById('systemStatus').innerHTML = 'çŠ¶æ€: <span class="text-yellow-600">é™çº§</span>';
                }
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = 'çŠ¶æ€: <span class="text-red-600">ç¦»çº¿</span>';
            }
        };
    </script>
</body>
</html>